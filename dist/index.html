<!DOCTYPE html>
<!--
* CoreUI - Free Bootstrap Admin Template
* @version v4.2.2
* @link https://coreui.io/product/free-bootstrap-admin-template/
* Copyright (c) 2023 creativeLabs Łukasz Holeczek
* Licensed under MIT (https://github.com/coreui/coreui-free-bootstrap-admin-template/blob/main/LICENSE)
-->

<!-- Breadcrumb-->
<html lang="en">
  <head>
    <base href="./">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta name="description" content="CoreUI - Open Source Bootstrap Admin Template">
    <meta name="author" content="Łukasz Holeczek">
    <meta name="keyword" content="Bootstrap,Admin,Template,Open,Source,jQuery,CSS,HTML,RWD,Dashboard">
    <title>IRMS: Home</title>
    <link rel="icon" type="image/png" sizes="192x192" href="assets/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="96x96" href="assets/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/android-icon-192x192.png">
    <link rel="manifest" href="assets/favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="assets/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
    <!-- Vendors styles-->
    <link rel="stylesheet" href="node_modules/simplebar/dist/simplebar.css">
    <link rel="stylesheet" href="css/vendors/simplebar.css">
    <!-- Main styles for this application-->
    <link href="css/newStyle.css" rel="stylesheet">
    <link href="node_modules/@coreui/chartjs/dist/css/coreui-chartjs.css" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!--jquery dataTable-->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <link href="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-1.13.7/af-2.6.0/b-2.4.2/b-colvis-2.4.2/b-html5-2.4.2/b-print-2.4.2/cr-1.7.0/date-1.5.1/fc-4.3.0/fh-3.4.0/kt-2.11.0/r-2.5.0/rg-1.4.1/rr-1.4.1/sc-2.3.0/sb-1.6.0/sp-2.2.0/sl-1.7.0/sr-1.3.0/datatables.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-1.13.7/af-2.6.0/b-2.4.2/b-colvis-2.4.2/b-html5-2.4.2/b-print-2.4.2/cr-1.7.0/date-1.5.1/fc-4.3.0/fh-3.4.0/kt-2.11.0/r-2.5.0/rg-1.4.1/rr-1.4.1/sc-2.3.0/sb-1.6.0/sp-2.2.0/sl-1.7.0/sr-1.3.0/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
   <style>
        .swal2-container {
          z-index: 20000 !important;
        }

        #map {
            width: 100%;
            height: 600px;
        }
        /* Add this CSS to hide Mapbox and OpenStreetMap attributions */
        .mapboxgl-ctrl-attrib,
        .mapboxbox-improve-map {
            display: none;
        }
        .custom-popup {
          background-color: #1505dc;
          padding: 12px;
          border-radius: 18px;
          box-shadow:  0px 0px 5px rgba(0, 0, 0, 0.2);
          font-size: 16px;
          color: white;
        }

        .mapboxgl-popup-content {
          position: static;
          padding-left: 10px;
          padding-right: 10px;
          padding-top: 10px;
          padding-bottom: 8px;
          font-family: 'Open Sans', sans-serif;
          border-radius: 25px !important;
          opacity: 1 !important;
          width: auto;
          max-height: 100%; /* Adjust height automatically */
          overflow: hidden; /* Hide overflow content if it exceeds max-height */
          display: inline-block; /* Display as inline-block */
          background-color: #fd7e14;
        }

        #videoElement,
        #imageElement {
          max-width: 100%;
          height: 450px;
        }

        /* Change the anchor background color */
        .mapboxgl-popup-anchor-top .mapboxgl-popup-tip,
        .mapboxgl-popup-anchor-top-left .mapboxgl-popup-tip,
        .mapboxgl-popup-anchor-top-right .mapboxgl-popup-tip {
            border-bottom-color: #fd7e14;
            }
        .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip,
        .mapboxgl-popup-anchor-bottom-left .mapboxgl-popup-tip,
        .mapboxgl-popup-anchor-bottom-right .mapboxgl-popup-tip {
            border-top-color: #fd7e14;
            }
        .mapboxgl-popup-anchor-left .mapboxgl-popup-tip {
            border-right-color: #fd7e14;
            }
        .mapboxgl-popup-anchor-right .mapboxgl-popup-tip {
            border-left-color: #fd7e14;
            }

        /* Target the close button in a more specific manner */
        .mapboxgl-popup-close-button {
          display: none !important;
        }

        /* Customize the DataTables responsive control icon */
        /* For the collapsed state */
        table.dataTable.dtr-inline.collapsed > tbody > tr > td.dtr-control::before {
            display: none;
        }

        /* For the expanded state */
        table.dataTable.dtr-inline > tbody > tr > td.dtr-control:hover::before,
        table.dataTable.dtr-inline > tbody > tr > td.dtr-control:focus::before {
          display: none;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        ::-webkit-scrollbar {
          width: 10px;
          height: 5px;
          background-color: #f5f5f5;
        }

        ::-webkit-scrollbar-thumb {
          border-radius: 10px;
          background-color: #959aa14d;
        }

        /* Mozilla */
        ::-moz-scrollbar {
          width: 10px;
          height: 5px;
          background-color: #f5f5f5;
        }

        ::-moz-scrollbar-thumb  {
          border-radius: 10px;
          background-color:  #959aa14d;
        }

        /* Microsoft */
        ::-ms-scrollbar {
          width: 10px;
          height: 5px;
          background-color: #f5f5f5;
        }

        ::-ms-scrollbar-thumb  {
          border-radius: 10px;
          background-color: #959aa14d;
        } 


    </style>
  </head>
  <body >

    <!-- Validate location modal -->
    <div class="modal fade" id="validate_location" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div  class="modal-header text-white px-4 py-2" style="background-color: #fd7e14;">
            <h6 class="modal-title" id="exampleModalLabel">Validate Location</h6>
            <button type="button" class="btn-close" id="close_validate_location_modal"  data-coreui-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body"> 
            <form>
              <div class="mb-3">
                <p>Please enter the headquarter's new location coordinates (long and lat).</p>
              </div>
              <div class="mb-3 has-validation">
                <label for="recipient-name" class="col-form-label">New Location Name:</label>
                <input type="text" class="form-control" id="new_location_name">
                <div class="invalid-feedback">
                  Invalid input.
                </div>
              </div>
              <div class="mb-3 has-validation">
                <label for="recipient-name" class="col-form-label">New Longitude:</label>
                <input type="number" class="form-control" id="new_long">
                <div class="invalid-feedback">
                  Invalid input.
                </div>
              </div>
              <div class="mb-3 has-validation">
                <label for="recipient-name" class="col-form-label">New Latitude:</label>
                <input type="number" class="form-control" id="new_lat">
                <div class="invalid-feedback">
                  Invalid input.
                </div>
              </div>
              <div class="mb-3">
                <button type="button" class="btn btn-primary" id="auto_generate" >
                  <span id="auto_generate_txt">Auto Generate</span>
                  <span class="spinner-border spinner-border-sm mt-1 ms-auto d-none" id="auto_generate_loader" aria-hidden="true"></span>
                </button>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="submit_new_location">Submit</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Show Accident/Incident area -->
    <div class="modal fade" id="show_accident_incident_area" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header text-white px-4 py-2" style="background-color: #fd7e14;">
            <h6 class="modal-title" id="accident_incident_area_title">Highway Incident Location Info</h6>
            <button type="button" class="btn-close" id="close_accident_incident_area" data-coreui-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body bg-light">

            <div class="mb-3 rounded rounded-4  px-3 py-3 bg-white shadow shadow" >
            <!-- Video element -->
            <div class="py-3 px-3 d-none d-flex rounded rounded-4 border-0 shadow-sm justify-content-center" id="videoContainer" style="background-color: #C7C9CB;">
              <video controls autoplay class=" border-0 shadow rounded rounded-4" style="display: none;" id="videoElement"></video>
            </div>
            
            <!-- Image element -->
            <div class="py-3 px-3 d-none d-flex rounded rounded-4 border-0 shadow-sm justify-content-center" id="imageContainer" style="background-color: #C7C9CB;">
              <a href=""  target="_blank" id="imageLink"> <!-- Leave href empty initially -->
                <img class="border-0 shadow rounded rounded-4" id="imageElement" src="" alt="">
              </a>
            </div>
            
            </div>

            <div class=" py-2 px-2 rounded rounded-4 shadow-sm bg-white" >
              <div class="rounded rounded-4 py-2 text-center border-1 fw-bold shadow-sm text-black bg-white" >Reported by <span  id="alerterId">Sample User</span></div>
            </div>
            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary d-none" id="respond_btn">Respond</button>
            <button type="button" class="btn btn-success text-white d-none" id="mark_as_done">Mark as done</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Update Accout Info -->
    <div class="modal fade" id="update_account_form" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div  class="modal-header text-white px-4 py-2" style="background-color: #fd7e14;">
            <h6 class="modal-title" id="exampleModalLabel">Account Information</h6>
            <button type="button" class="btn-close" id="close_update_account_form_modal"  data-coreui-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body "> 
            <form>
              <div class="mb-3">
                <h6>Press this button if you want to receive a reset password email</h6>
                <button type="button" class="btn btn-primary mt-2" id="reset_password_btn" >
                  <span id="reset_password_txt">Reset Password</span>
                  <span class="spinner-border spinner-border-sm mt-1 ms-auto d-none" id="reset_password_spinner" aria-hidden="true"></span>
                </button>
              </div>
              <div class="mb-3 has-validation">
                <label for="recipient-name" class="col-form-label">First Name:</label>
                <input type="text" class="form-control" id="first_name">
                <div class="invalid-feedback">
                  Invalid input.
                </div>
              </div>
              <div class="mb-3 has-validation">
                <label for="recipient-name" class="col-form-label">Middle Name:</label>
                <input type="text" class="form-control" id="middle_name">
                <div class="invalid-feedback">
                  Invalid input.
                </div>
              </div>
              <div class="mb-5 has-validation">
                <label for="recipient-name" class="col-form-label">Last Name:</label>
                <input type="text" class="form-control" id="last_name">
                <div class="invalid-feedback">
                  Invalid input.
                </div>
              </div>
              <div class="mb-3 has-validation">
                <h6 class="mb-2">Default Information (Non-updatable Fields)</h6>
                <label for="recipient-name" class="col-form-label">Email:</label>
                <div class="border bg-success text-white border-1 border-dark border-opacity-50 rounded rounded-3" style="padding: 7px 5px 7px 10px;" id="email_add">Data</div>
              </div>
              <div class="mb-3 has-validation">
                <label for="recipient-name" class="col-form-label">Headquarter:</label>
                <div class="border bg-success text-white border-1 border-dark border-opacity-50 rounded rounded-3" style="padding: 7px 5px 7px 10px;" id="head_quarter">Data</div>
              </div>
              <div class="mb-3 has-validation">
                <label for="recipient-name" class="col-form-label">Profile:</label>
                <div class="border bg-success text-white border-1 border-dark border-opacity-50 rounded rounded-3" style="padding: 7px 5px 7px 10px;" id="profile_typr">Data</div>
              </div>
              <div class="mb-3 has-validation">
                <label for="recipient-name" class="col-form-label">Role:</label>
                <div class="border bg-success text-white border-1 border-dark border-opacity-50 rounded rounded-3" style="padding: 7px 5px 7px 10px;" id="role">Data</div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="update_account_now" >Update</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add New User Info -->
    <div class="modal fade" id="add_new_user_form" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div  class="modal-header text-white px-4 py-2" style="background-color: #fd7e14;">
            <h6 class="modal-title" id="exampleModalLabel">User Information</h6>
            <button type="button" class="btn-close" id="close_add_new_user_form_modal"  data-coreui-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body "> 
            <form>
              <div class="mb-3 has-validation">
                <label for="recipient-name" class="col-form-label">Email:</label>
                <input type="email" class="form-control" id="set_email">
                <div class="invalid-feedback">
                  Invalid email input.
                </div>
              </div>
              <div class="mb-3 has-validation">
                <label for="validationCustom04" class="form-label">Role</label>
                <select class="form-select" id="select_role" required>
                  <option selected disabled value="">Choose...</option>
                  <option value="Admin">Admin</option>
                  <option value="User">User</option>
                </select>
                <div class="invalid-feedback">
                  Please select a role
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="add_new_user_now" >Submit</button>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar sidebar-dark sidebar-fixed" id="sidebar">
      <div class="sidebar-brand d-none d-md-flex">
        <div class="sidebar-brand-full bg-transparent" >
          <img class="img-thumbnail bg-transparent border-0"  width="180" height="100" src="assets/brand/irms.png" alt="user@email.com">
        </div>
        <div class="sidebar-brand-narrow mx-1 my-1" width="46" height="46" alt="CoreUI Logo" >
          <img class="img-thumbnail bg-transparent border-0"  width="180" height="100" src="assets/brand/irms_logo_circle.png" alt="user@email.com">
        </div>
      </div>
      <ul class="sidebar-nav" data-coreui="navigation" data-simplebar>
        <li class="nav-title">Components</li>

        <li class="nav-item"><a class="nav-link" style="cursor: pointer;" id="validate_location" data-coreui-toggle="modal" data-coreui-target="#validate_location">
            <svg class="nav-icon">
              <use xlink:href="node_modules/@coreui/icons/sprites/free.svg#cil-chart-pie"></use>
            </svg> Validate Location</a>
        </li>

        <li class="nav-item"><a class="nav-link d-none" style="cursor: pointer;"  id="add_users" data-coreui-toggle="modal" data-coreui-target="#add_new_user_form">
          <svg class="nav-icon">
            <use xlink:href="node_modules/@coreui/icons/sprites/free.svg#cil-user-plus"></use>
          </svg> Add Users</a>
       </li>

       <li class="nav-item"><a tabindex="10" class="nav-link" style="cursor: pointer;" id="responded_reports"
          tabindex="0"
          data-coreui-toggle="responded_reports_popover" 
          data-coreui-placement="right"
          data-coreui-custom-class="responded_reports_popover"
          data-coreui-title="Responded Reports"
          data-coreui-content=" ">
        <svg class="nav-icon">
          <use xlink:href="node_modules/@coreui/icons/sprites/free.svg#cil-garage"></use>
        </svg> Responded Reports<span id="responded_count" class="position-absolute d-none translate-middle border-white ms-4 badge rounded-pill bg-success"> 
        </span></a>
      </li>
      </ul>
      <button class="sidebar-toggler" type="button" data-coreui-toggle="unfoldable"></button>
    </div>

    <div class="wrapper d-flex flex-column min-vh-100" style="background-color: rgb(238,240,240);">

      <header class="header header-sticky mb-3">
        <div class="container-fluid">
          <button class="header-toggler px-md-0 me-md-3" id="header-toggler" type="button" onclick="coreui.Sidebar.getInstance(document.querySelector('#sidebar')).toggle()">
            <svg class="icon icon-lg">
              <use xlink:href="node_modules/@coreui/icons/sprites/free.svg#cil-menu"></use>
            </svg>
          </button>
          <ul class="header-nav mt-2">
            <h5 id="profile_id"></h5>
          </ul>
          <ul class="header-nav ms-auto">
            <li class="nav-item " id="unresponded_alert_list" style="cursor: pointer;"><a class="nav-link" 
              tabindex="0"
              data-coreui-toggle="responded_reports_popover" 
              data-coreui-placement="top"
              data-coreui-custom-class="unresponded_reports_popover"
              data-coreui-title="Unresponded Reports"
              data-coreui-content=" " >
                <svg class="icon icon-lg" >
                  <use xlink:href="node_modules/@coreui/icons/sprites/free.svg#cil-bell"></use>
                </svg>
                <span id="new_alerts" class="position-absolute d-none start-10 translate-middle badge rounded-pill bg-danger"></span>
              </a>
            </li>
          </ul>
          <ul class="header-nav ms-3" style="margin-bottom: 5px;">
            <li class="nav-item dropdown"><a id="other_options" class="nav-link py-0" data-coreui-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                <div class="avatar avatar-md"><img class="avatar-img" src="assets/brand/irms_logo_circle.png" alt="user@email.com"></div></a>
              <div class="dropdown-menu dropdown-menu-end pt-0">
                <div class="dropdown-header  py-2" style="background-color: #fd7e14;">
                  <div class="fw-semibold text-white" >Account</div>
                </div><a class="dropdown-item" id="update_account_option" style="cursor: pointer;" data-coreui-toggle="modal" data-coreui-target="#update_account_form">
                  <svg class="icon me-2">
                    <use xlink:href="node_modules/@coreui/icons/sprites/free.svg#cil-lock-locked"></use>
                  </svg> Update Account</a>
                  <a class="dropdown-item" style="cursor: pointer;" id="logout">
                  <svg class="icon me-2">
                    <use xlink:href="node_modules/@coreui/icons/sprites/free.svg#cil-account-logout"></use>
                  </svg> Logout</a>
              </div>
            </li>
          </ul>
        </div>
        <div class="header-divider"></div>
        <div class="container-fluid">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb my-0 ms-2">
              <li class="breadcrumb-item active"><span>Current User: </span> <span id="display_fname"></span> <span id="display_mname"></span> <span id="display_lname"></span></li>
            </ol>
          </nav>
        </div>
      </header>

      <div class="body flex-grow-1 p-2">
        <div class="container-lg">
          <!-- /.row-->
          <div class="card mb-3">
            <div class="card-body" id="map-box">
            </div>
          </div>
        </div>
      </div>
      <footer class="footer  border-0 shadow-lg " id="footer" style="background-color: rgba(242,242,242,0.56);">
        <div>© 2023 IRMS v1.0 | All Rights Reserved</div>
      </footer>
    </div>
    <!-- CoreUI and necessary plugins-->
    <script src="node_modules/@coreui/coreui/dist/js/coreui.bundle.min.js"></script>
    <script src="node_modules/simplebar/dist/simplebar.min.js"></script>
    <!-- Plugins and scripts required by this view-->
    <script type="module" src="js/firebaseConfig.js"></script>
    <script type="module"> 
       import { getAuth, signInWithEmailAndPassword,  createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
       import { doc, getDoc, getDocs, deleteDoc, getFirestore, collection, query, where, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
       import { genMap, setContent, getFileExtension } from "./js/alert_map.js"      
       const logoutButton =  document.getElementById("logout");
       const updateAccountId =  document.getElementById("update_account_option");
       const reset_passwordID =  document.getElementById("reset_password_btn");
       const respondButton = document.getElementById("respond_btn");
       const addNewUserButton = document.getElementById("add_new_user_now");
       const updateAccountBtnId = document.getElementById("update_account_now");
       const db = getFirestore();
       const check = getAuth();
       
       // Your Mapbox access token
       const mapboxAccessToken = 'pk.eyJ1IjoiZGV2YWVzMjAyMSIsImEiOiJja3Y2ZzdsNHgwdjNjMnRva25ydWl5dXBiIn0.PGH3gPOO163DcTiQJdVRlA';
       var toastMixin = Swal.mixin({
           toast: true,
           icon: 'success',
           title: 'General Title',
           position: 'top',
           showConfirmButton: false,
           timer: 5000,
           timerProgressBar: true,
           didOpen: (toast) => {
             toast.addEventListener('mouseenter', Swal.stopTimer)
             toast.addEventListener('mouseleave', Swal.resumeTimer)
          }
        });
       const popoverTriggerList = document.querySelectorAll('[data-coreui-toggle="responded_reports_popover"]')
       const popoverClass = 'responded_reports_popover'; // Adjust the class name as needed
       const sidebarId = 'sidebar'; // Adjust the sidebar ID as needed
       const popoverList = [...popoverTriggerList].map((popoverTriggerEl) => {
       const popover = new coreui.Popover(popoverTriggerEl, {
        container: 'body',
        trigger: 'click',
      });
      var incidentId;

        // Add a click event listener to the document to hide the popover
        //document.addEventListener('click', (event) => 
        //{
          //const popoverElement = document.querySelector(`.${popoverClass}`);
          //const isClickInsidePopover = popoverTriggerEl.contains(event.target) || (popoverElement && popoverElement.contains(event.target));

           //If the click is not inside the popover or its trigger, hide it
          // if (!isClickInsidePopover) 
           //{
            // popover.hide();
           //}
        //});

        return popover;
      });

      const popoverTriggerDropdownAlerts = document.querySelectorAll('[data-coreui-toggle="unresponded_reports_popover"]')
      const popoverDropdownAlertsClass = 'unresponded_reports_popover';
      const popoverListDropdownAlertsClass = [...popoverTriggerDropdownAlerts].map((e) => {
      const popover2 = new coreui.Popover(e, {
        container: 'body',
        trigger: 'click',
      });
        return popover2;
      });

      // Add mouseenter event listener to the sidebar to update popover positions
      document.getElementById(sidebarId).addEventListener('mouseout', () => {
          // Loop through the popover list and update positions
          popoverList.forEach((popover) => {
            popover.update();
          });
        });

      // Add mouseenter event listener to the sidebar to update popover positions
      document.getElementById(sidebarId).addEventListener('mouseenter', () => {
          // Loop through the popover list and update positions
          popoverList.forEach((popover) => {
            popover.update();
          });
        });
      
      onAuthStateChanged(check, (user) => 
      {
        if (user) {
          const uid = user.uid;
          const name = getUserId(uid).then((fulfilledValue) => {
          const  first_name  = fulfilledValue.first_name;
          const  middle_name  = fulfilledValue.middle_name;
          const  last_name = fulfilledValue.last_name;
          const  profile = fulfilledValue.profile;
          const  role = fulfilledValue.role;
          const  head_quarter = fulfilledValue.head_quarter;
          const display_fname = document.getElementById("display_fname");
          const display_mname = document.getElementById("display_mname");
          const display_lname = document.getElementById("display_lname");

          display_fname.innerHTML = capitalizeFirstLetterOfWords(first_name);
          display_mname.innerHTML = capitalizeFirstLetterOfWords(middle_name);
          display_lname.innerHTML = capitalizeFirstLetterOfWords(last_name);

          updateAccountId.onclick = function ()
          {
            changeMyAccountInfo(user.email, first_name, middle_name, last_name, uid, head_quarter, profile, role)
          }

          addNewUserButton.onclick = function ()
          {
            validateNewUserInfo(profile, role, head_quarter)
          }

          if(role === "Admin")
          {
            document.getElementById('add_users').classList.remove('d-none')
          }

          const originLongLat = getOriginLongLat(profile, head_quarter).then((resultValues) =>{
          const origin = [resultValues.long, resultValues.lat];
          const headquarter_info = [ resultValues.lat,  resultValues.long,  resultValues.headquarter_location_name,
          resultValues.headquarter_name, ];
          const headquarterLocationName = headquarter_info[2];
          

          // Get a reference to the element by its id
          const profileElement = document.getElementById("profile_id");

          // Set the text content of the element
          profileElement.textContent = capitalizeFirstLetterOfWords(profile);

          get_dest(origin, head_quarter, capitalizeFirstLetterOfWords(profile)) ;

          // To start listening for updates, call the function
          const unsubscribeAlertUpdates = listenToAlertUpdates(head_quarter, origin, capitalizeFirstLetterOfWords(profile));

          // Select the button by its id
          const myButton = document.getElementById('try');

          submit_new_location(profile, head_quarter);

          respondToALert(head_quarter, capitalizeFirstLetterOfWords(profile), capitalizeFirstLetterOfWords(headquarterLocationName));

          respondedCount(head_quarter);

          alertCount(head_quarter);

          renderRespondedReportsPopOver(head_quarter);
          renderUnrespondedReportsPopOver(head_quarter);

          // Call the function initially and add an event listener to update on window resize
          footerStyle();
          window.addEventListener("resize", footerStyle);
          
          });
          }).catch((error) => {
          console.error("Error:", error);
          });
        } else {
          window.location.href = "login.html";
        }
      });

      async function get_dest(origin, headquarter_id, profile_name)
       {
            // Define the query to get documents where headquarter_id is equal to pos2
            const q = query(collection(db, 'temp_logs'), 
            where('headquarter_id', '==', headquarter_id),
            where("responded", "==", false));

            // Fetch the documents that match the query
            const querySnapshot = await getDocs(q);

            // Initialize an empty array to store the destinations
            const destinations = [];

            // Loop through the documents and add them to the destinations array
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                // Use the stored randomColor instead of generating a new one
                destinations.push({
                    coordinates: [data.long, data.lat],
                    filepath: data.media_url,
                    color: '#EE3139',
                    location_id: data.alert_location,
                    alert_by:data.user_name
                });
            });

          // Assign the result to a variable
          const hospitalList = await getHospitalList();

          genMap(origin, destinations, mapboxAccessToken, profile_name, capitalizeFirstLetterOfWords(headquarter_id), hospitalList);
       }

      function capitalizeFirstLetterOfWords(str) {
        return str.replace(/\b\w/g, match => match.toUpperCase());
      }
      
      function listenToAlertUpdates(head_quarter, origin, profile_name) 
      {
        let alerts = [];

        // Create an audio element for the alert sound
        const alertSound = new Audio('assets/brand/beep-warning-6387.mp3'); 
        
        // Create a query for the "temp_logs" collection with a filter for "head_quarter" equal to "pos2"
        const q = query(collection(db, "temp_logs"),
        where("headquarter_id", "==", head_quarter),
        where("responded", "==", false));

        const unsubscribe = onSnapshot(q, (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {

              const alertText = 'An accident has occurred at ' + change.doc.data().alert_location;
      
              // Add the new alert to the bottom of the array
              alerts.push(alertText);

                  // Display the alerts in reverse order
                alerts.reverse().forEach((alert, index) => {
                  setTimeout(() => {
                    toastMixin.fire({
                      title: alert,
                      icon: 'warning'
                    });

                    alertSound.autoplay = true;
                    alertSound.load();
                    
                  }, index * 5000); // Adjust the delay between alerts if needed
                });

              // Reverse the array again to maintain the correct order for future alerts
              alerts.reverse();
              get_dest(origin, head_quarter, profile_name) 
              respondedCount(head_quarter)
              alertCount(head_quarter)
              
            }
            else if(change.type === "removed")
            {
              get_dest(origin, head_quarter, profile_name) 
              respondedCount(head_quarter)
              alertCount(head_quarter)
              alerts = [];
            }
            
          });
        });
      }

      async function getUserId(input_id)
      {
          const subcollectionPath = "/accounts/";
          const documentId = input_id;

          // Create a reference to the specific document within the subcollection
          const documentRef = doc(db, subcollectionPath, documentId);

          try {
            // Check if the document exists and wait for it to resolve
            const documentSnapshot = await getDoc(documentRef);

            if (documentSnapshot.exists()) {
              // Access the "first_name" field
              const age = documentSnapshot.data().age;
              const city_municipality = documentSnapshot.data().city_municipality;
              const first_name = documentSnapshot.data().first_name;
              const last_name = documentSnapshot.data().last_name;
              const middle_name = documentSnapshot.data().middle_name;
              const profile = documentSnapshot.data().profile;
              const province = documentSnapshot.data().province;
              const head_quarter = documentSnapshot.data().head_quarter;
              const role = documentSnapshot.data().role;
              const street_address = documentSnapshot.data().street_address;

              return {

                first_name: first_name,
                middle_name:middle_name,
                last_name:last_name,
                age:age,
                street_address:street_address,
                city_municipality:city_municipality,
                province:province,
                profile:profile,
                role:role,
                head_quarter:head_quarter

              };
            } else {
              console.log("Document does not exist.");
            }
          } catch (error) {
            console.error("Error fetching document:", error);
          }
      }

      async function getOriginLongLat(profile_type, head_quarter) 
      {
        const subcollectionPath = "/profile/"+profile_type+"/head_quarters";
        const documentId = head_quarter;

        // Create a reference to the specific document within the subcollection
        const documentRef = doc(db, subcollectionPath, documentId);

        try {
          // Check if the document exists and wait for it to resolve
          const documentSnapshot = await getDoc(documentRef);

          if (documentSnapshot.exists()) {
            // Access the "first_name" field
            const lat = documentSnapshot.data().lat;
            const long = documentSnapshot.data().long;
            const headquarter_location_name = documentSnapshot.data().headquarter_location_name;
            const headquarter_name = documentSnapshot.data().headquarter_name;

            return {

              lat:lat,
              long:long,
              headquarter_location_name:headquarter_location_name,
              headquarter_name:headquarter_name,                          

            };
          } else {
            console.log("Document does not exist.");
          }
        } catch (error) {
          console.error("Error fetching document:", error);
        }
      }

      function getLocation() 
      {
        document.getElementById("auto_generate_txt").classList.add("d-none");
        document.getElementById("auto_generate_loader").classList.remove("d-none");
        if ("geolocation" in navigator) {
           navigator.geolocation.getCurrentPosition(function (position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            const apiKey = mapboxAccessToken;
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${longitude},${latitude}.json?access_token=${apiKey}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        const new_location_name = data.features[0].place_name;
                        
                        // Update the input fields with the latitude and longitude values
                        document.getElementById("new_lat").value = latitude;
                        document.getElementById("new_long").value = longitude;
                        document.getElementById("new_location_name").value = new_location_name;
                    } else {
                        document.getElementById('result').innerHTML = 'Location not found';
                    }

                    document.getElementById("auto_generate_txt").classList.remove("d-none");
                    document.getElementById("auto_generate_loader").classList.add("d-none");
                })
                .catch(error => {
                    console.error('Error:', error);

                    document.getElementById("auto_generate_txt").classList.remove("d-none");
                    document.getElementById("auto_generate_loader").classList.add("d-none");
                });

          }, function (error) {
            // Handle errors here
            switch (error.code) {
              case error.PERMISSION_DENIED:
                alert("Location access denied by user.");
                break;
              case error.POSITION_UNAVAILABLE:
                alert("Location information is unavailable.");
                break;
              case error.TIMEOUT:
                alert("Location request timed out.");
                break;
              default:
                alert("An unknown error occurred.");
                break;
            }

            document.getElementById("auto_generate_txt").classList.remove("d-none");
            document.getElementById("auto_generate_loader").classList.add("d-none");
          });
        } else {
          alert("Geolocation is not supported by your browser.");
          document.getElementById("auto_generate_txt").classList.remove("d-none");
          document.getElementById("auto_generate_loader").classList.add("d-none");
        }
      }
      document.getElementById("auto_generate").addEventListener("click", getLocation);

      async function submit_new_location(profile, head_quarter)
      {
          document.getElementById("submit_new_location").onclick = async function()
          {
            const new_location_name = document.getElementById('new_location_name');
            const new_loaction_name_value = new_location_name.value;
            const new_long = document.getElementById('new_long');
            const new_long_value = new_long.value;
            const new_lat = document.getElementById('new_lat');
            const new_lat_value = new_lat.value;
            let is_valid = true;
            const closeButton  = document.getElementById('close_validate_location_modal');

            if(new_loaction_name_value.trim().length === 0)
            {
              new_location_name.classList.add("is-invalid");
              is_valid = false;
            }

            if(new_long_value.trim().length === 0)
            {
              new_long.classList.add("is-invalid");
              is_valid = false;
            }

            if(new_lat_value.trim().length === 0)
            {
              new_lat.classList.add("is-invalid");
              is_valid = false;
            }
             

            if(is_valid)
            {
              const subcollectionPath = "/profile/" + profile + "/head_quarters";
              const documentId = head_quarter;
              const origin = [parseFloat(new_long_value), parseFloat(new_lat_value)];
              let is_listening = false;
              const update = doc(db, subcollectionPath, documentId);

              try {
                await updateDoc(update, {
                  headquarter_location_name: new_loaction_name_value,
                  lat: new_lat_value,
                  long: new_long_value
                });

                 // The update was successful, so display a success alert.
                toastMixin.fire({
                  title:'Success: Headquarter location updated successfully' ,
                  icon: 'success',
                  timer: 3000
                });

                //refresh after update
                setTimeout(function()
                {
                  location.reload();
                },3000)
                
               

              } catch (error) {
                // An error occurred during the update, so display an error alert.
                toastMixin.fire({
                  title:error.message ,
                  icon: 'warning',
                  timer: 3000
                });
              }
            }
          };
      }

      logoutButton.onclick = function ()
      {
        signOut(check).then(() => {
          window.location.href = "login.html";
        }).catch((error) => {
          console.log(error);
        });
      };

      async function sendResetPasswordEmail(email)
      { 
        $("#reset_password_txt").addClass("d-none")
        $("#reset_password_spinner").removeClass("d-none")
        sendPasswordResetEmail(check, email)
          .then(() => {
            console.log("email sent: " + email)
            toastMixin.fire({
            title: 'A reset email link has been sent to '+email,
            icon: 'success',
            timer: 3000
          });

            $("#reset_password_txt").removeClass("d-none")
            $("#reset_password_spinner").addClass("d-none")
          })
          .catch((error) => {
            const errorCode = error.code;
            const errorMessage = error.message;
            toastMixin.fire({
            title: 'Something went wrong reset password did not sent to '+email,
            icon: 'warning',
            timer: 3000
          });
            $("#reset_password_txt").removeClass("d-none")
            $("#reset_password_spinner").addClass("d-none")
          });
          
      }

      function changeMyAccountInfo(email, first_name, middle_name, last_name, uid, head_quarter, profile, role)
      {
          const email_add = document.getElementById("email_add");
          const head_quarter_id = document.getElementById("head_quarter");
          const profile_typr_id = document.getElementById("profile_typr");
          const role_id = document.getElementById("role");
          const first_name_id = document.getElementById("first_name")
          const middle_name_id = document.getElementById("middle_name")
          const last_name_id = document.getElementById("last_name")
          reset_passwordID.onclick = function ()
          {
            sendResetPasswordEmail(email)
          }
          email_add.innerHTML = email;
          head_quarter_id.innerHTML = head_quarter;
          profile_typr_id.innerHTML = profile;
          role_id.innerHTML = role;
          first_name_id.value = first_name;
          middle_name_id.value = middle_name;
          last_name_id.value = last_name;

          updateAccountBtnId.onclick = function ()
          {
            let isValid = true;

            if(first_name_id.value.trim().length === 0)
            {
              first_name_id.classList.add("is-invalid");
              isValid = false;
            }
            if(middle_name_id.value.trim().length === 0)
            {
              middle_name_id.classList.add("is-invalid");
              isValid = false;
            }
            if(last_name_id.value.trim().length === 0)
            {
              last_name_id.classList.add("is-invalid");
              isValid = false;
            }

            if(isValid)
            {
              updateAccountNow(uid);
            }
            
          }
      }

      async function updateAccountNow(uid)
      {
        const accountId = uid;
        const first_name_val = $("#first_name").val();
        const middle_name_val = $("#middle_name").val();
        const last_name_val = $("#last_name").val();
        const accountRef = doc(db, 'accounts', accountId);

        // Create an object with the new data
        const newData = {
          first_name: capitalizeFirstLetterOfWords(first_name_val),
          middle_name: capitalizeFirstLetterOfWords(middle_name_val),
          last_name: capitalizeFirstLetterOfWords(last_name_val)
        };

        // Update the document with the new data
        updateDoc(accountRef, newData)
          .then(() => {
            console.log("Document successfully updated!");
            
            // The update was successful, so display a success alert.
            toastMixin.fire({
                title:'Success: Account Successfully updated' ,
                icon: 'success',
                timer: 3000
              });

              //refresh after update
              setTimeout(function()
              {
                location.reload();
              },3000)
          })
          .catch((error) => {
            console.error("Error updating document: ", error);
          });
      }

      document.getElementById("other_options").onclick = function ()
      {
        popoverList.forEach((popover2) => {
          popover2.hide();
        });
      }

      // Function to add or remove footer styles based on screen width
      function footerStyle() 
      {
          const footer = document.getElementById("footer");

          if (window.innerWidth < 768) {
            // Screen width is less than 770

            footer.classList.add('justify-content-center');

          } else {
            // Screen width is 770 or greater
            footer.classList.remove('justify-content-center');
          }
       }

      function respondToALert(head_quarter, profile, hqLocationName)
      {
        respondButton.onclick = function ()
        {
          responded(head_quarter, profile, hqLocationName)
        }
      }

      async function respondedCount(head_quarter)
      {
        const q = query(
          collection(db, "temp_logs"),
          where("headquarter_id", "==", head_quarter),
          where("responded", "==", true)
        );

        try {
          const querySnapshot = await getDocs(q);
          let count = querySnapshot.size; // Get the count of documents

          const respondedCountBadge = document.getElementById('responded_count');
          const respondedCount = parseInt(count); // Replace with the actual count value

          if (respondedCount <= 0) {
            respondedCountBadge.classList.add('d-none');
          } else {
            respondedCountBadge.classList.remove('d-none');
            respondedCountBadge.textContent = respondedCount;
          }

        } catch (error) {
          console.error("Error getting documents: ", error);
        }
      }
      
      async function alertCount(head_quarter)
      {
        const q = query(
          collection(db, "temp_logs"),
          where("headquarter_id", "==", head_quarter),
          where("responded", "==", false)
        );

        try {
          const querySnapshot = await getDocs(q);
          let count = querySnapshot.size; // Get the count of documents

          const alertCountBadge = document.getElementById('new_alerts');
          const alertCount = parseInt(count); // Replace with the actual count value

          if (alertCount <= 0) {
            alertCountBadge.classList.add('d-none');
          } else {
            alertCountBadge.classList.remove('d-none');
            alertCountBadge.textContent = alertCount;
          }

        } catch (error) {
          console.error("Error getting documents: ", error);
        }
      }

      async function isResponded(head_quarter, accident_incident_area_title_text, alerterId_text)
      {
        const q = query(
          collection(db, "temp_logs"),
          where("headquarter_id", "==", head_quarter),
          where("alert_location", "==", accident_incident_area_title_text),
          where("user_name", "==", alerterId_text),
          where("responded", "==", false)
        );
        
        const logsSnapshot = await getDocs(q);

        // Iterate through the documents in the query results and update the "responded" field.
        for (const doc of logsSnapshot.docs) {
            const docRef = doc.ref;
            // Use the setDoc function to update the "responded" field to true.
            await setDoc(docRef, { responded: true }, { merge: true });
          }

      }

      function sendPushNotification(expoToken, profile, head_quarter, accident_incident_area_title_text, alerterId_text, message, markAsDone) 
      {
        const apiUrl = 'https://exp.host/--/api/v2/push/send';
        const notificationData = {
          to: expoToken,
          title: profile,
          body: profile + message
        };

        // Construct a request object
        const request = new Request(apiUrl, {
          method: 'POST',
          mode: 'no-cors',
          headers: new Headers({
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'Accept-Encoding': 'gzip, deflate',
          }),
          body: JSON.stringify(notificationData),
        });

        // Send the request
        fetch(request)
        .then(() => {

          let response = 'The response message has been successfully sent';
          // The update was successful, so display a success alert.
          if(markAsDone)
          {
            response = 'The report has been marked as done'
          }

          toastMixin.fire({
            title: 'Success: '+response,
            icon: 'success',
            timer: 3000
          });

          popoverList.forEach((popover) => {
            popover.hide();
            });

          // Get the button element by its ID
          var button = document.getElementById("close_accident_incident_area");
          if(!markAsDone)
          {
            isResponded(head_quarter, accident_incident_area_title_text, alerterId_text)
          }
          
            // Check if the button element exists
            if (button) {
              // Trigger the click event on the button
              button.click();
            } else {
              console.error("Button not found");
            }

        })
        .catch((error) => {
          console.error('Error sending push notification request:', error);

          // The update was successful, so display a success alert.
          toastMixin.fire({
            title: 'Error: The response message could not be sent',
            icon: 'error',
            timer: 3000
          });
        });
      }

      function renderRespondedReportsPopOver(head_quarter) 
      {
      
        // Select the element with the class 'responded_reports_popover'
        var respondedReportsPopover = document.querySelector('.responded_reports_popover');

        // Create a new MutationObserver with a callback function
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                // Check if the target node (addedNodes) contains the desired element
                if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                    for (var i = 0; i < mutation.addedNodes.length; i++) {
                        // Check if the added node is defined and has the class 'responded_reports_popover'
                        if (
                            mutation.addedNodes[i] &&
                            mutation.addedNodes[i].classList &&
                            mutation.addedNodes[i].classList.contains('responded_reports_popover')
                        ) {
                            // Select the element with the class 'responded_reports_popover'
                            var respondedReportsPopover = document.querySelector('.responded_reports_popover');
                            var popoverHeader = respondedReportsPopover.querySelector('.popover-header');
                            var popoverBody = respondedReportsPopover.querySelector('.popover-body');

                            // Check if the element exists and has a child element with the class 'popover-header'
                            if (respondedReportsPopover && popoverHeader && popoverBody) {

                              respondedReportsPopover.classList.add("border-0");
                              respondedReportsPopover.classList.add("shadow");
                              respondedReportsPopover.classList.add("shadow-sm");
                              
                              // Add the 'id' attribute with the value 
                              popoverHeader.id = 'respondPop_header';
                              const popoverHeaderId = document.getElementById('respondPop_header');
                              popoverBody.id = 'respondPop_body';
                              const popoverHeaderBody = document.getElementById('respondPop_body');

                              // Apply the CSS style
                              popoverHeaderId.style.backgroundColor = '#fd7e14';
                              popoverHeaderId.classList.add('text-white');
                              popoverHeaderId.classList.add("border-0");
                              popoverHeaderId.classList.add("shadow");
                              popoverHeaderId.classList.add("shadow-sm");

                              // Create a button element
                              var bodyContent = document.createElement('div');
                              bodyContent.id = 'respondPop_header_bodyContent';
                              bodyContent.className = 'shadow shadow-sm'
                              // Append the button to the popover-body
                              popoverHeaderBody.appendChild(bodyContent); 
                              const tableHTML = `<table id="myTable" class="hover stripe table-info"></table>`;

                              // Insert the table into the element with ID 'respondPop_header'
                              $('#respondPop_header_bodyContent').append(tableHTML);

                              showRespondedAlerts(head_quarter)
                              // You may also disconnect the observer if you only need to log once
                              //observer.disconnect();
                              //break;

                            } else {
                                console.log('false');
                              }

                        }
                    }
                }
            });
        });
        // Configure the observer to watch for changes in the subtree (child elements) of the target node
        var observerConfig = { childList: true, subtree: true };
        // Start observing the target node for configured mutations
        observer.observe(document.body, observerConfig);
      }

      function renderUnrespondedReportsPopOver(head_quarter) 
      {
      
        // Select the element with the class 'responded_reports_popover'
        var respondedReportsPopover = document.querySelector('.unresponded_reports_popover');

        // Create a new MutationObserver with a callback function
        var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                // Check if the target node (addedNodes) contains the desired element
                if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                    for (var i = 0; i < mutation.addedNodes.length; i++) {
                        // Check if the added node is defined and has the class 'responded_reports_popover'
                        if (
                            mutation.addedNodes[i] &&
                            mutation.addedNodes[i].classList &&
                            mutation.addedNodes[i].classList.contains('unresponded_reports_popover')
                        ) {
                            // Select the element with the class 'responded_reports_popover'
                            var respondedReportsPopover = document.querySelector('.unresponded_reports_popover');
                            var popoverHeader = respondedReportsPopover.querySelector('.popover-header');
                            var popoverBody = respondedReportsPopover.querySelector('.popover-body');
                            var popoverArrow = respondedReportsPopover.querySelector('.popover-arrow');

                            // Check if the element exists and has a child element with the class 'popover-header'
                            if (respondedReportsPopover && popoverHeader && popoverBody && popoverArrow) {

                              respondedReportsPopover.classList.add("border-0");
                              respondedReportsPopover.classList.add("shadow");
                              respondedReportsPopover.classList.add("shadow-sm");
                              
                              // Add the 'id' attribute with the value 
                              popoverHeader.id = 'unrespondPop_header';
                              const popoverHeaderId = document.getElementById('unrespondPop_header');
                              popoverBody.id = 'unrespondPop_body';
                              const popoverHeaderBody = document.getElementById('unrespondPop_body');
                              popoverArrow.id = 'unrespondedArrowTip';
                              // Select the element
                              var element = document.querySelector('.popover .unresponded_reports_popover .bs-popover-auto .popover-arrow');

                              // Check if the element exists
                              if (element) {
                                // Set the ID
                                element.setAttribute('id', 'yourDesiredId');
                              }

                              // Apply the CSS style
                              popoverHeaderId.style.backgroundColor = '#fd7e14';
                              popoverHeaderId.classList.add('text-white');
                              popoverHeaderId.classList.add("border-0");
                              popoverHeaderId.classList.add("shadow");
                              popoverHeaderId.classList.add("shadow-sm");

                              // Create a body element
                              var bodyContent = document.createElement('div');
                              bodyContent.id = 'unrespondPop_header_bodyContent';
                              bodyContent.className = 'shadow shadow-sm'
                              // Append the body to the popover-body
                              popoverHeaderBody.appendChild(bodyContent);
                              const tableHTML = `<table id="myTable2" class="hover stripe table-info"></table>`;

                              // Insert the table into the element with ID 'respondPop_header'
                              $('#unrespondPop_header_bodyContent').append(tableHTML);

                              showUnrespondedAlerts(head_quarter)
                              // You may also disconnect the observer if you only need to log once
                              //observer.disconnect();
                              //break;

                            } else {
                                console.log('false');
                            }

                        }
                    }
                }
            });
        });
        // Configure the observer to watch for changes in the subtree (child elements) of the target node
        var observerConfig = { childList: true, subtree: true };
        // Start observing the target node for configured mutations
        observer.observe(document.body, observerConfig);
      }

      function createDataTable(data) {
            // Example data (replace this with your dynamic data)
            let dynamicData = data;

            // Customize columns
            let columns = [
                {
                  render: function (data, type, row) {
                    // You can customize the rendering of data in this column
                    return '<div style = "width: 200px;">'+data+'</div>';
                }},
                {
                  render: function (data, type, row) {
                    // You can customize the rendering of data in this column
                    return '<div style = "width: 200px;">'+data+'</div>';
                }},
                {
                  render: function (data, type, row) {
                    // You can customize the rendering of data in this column
                    return '<div class="mb-2" style = "width: 200px;">'+
                      '<button type="button" onclick="showMore(this.id)" class="btn btn-primary more_details" id="'+data+'" data-coreui-toggle="modal" data-coreui-target="#show_accident_incident_area">More</button>'+
                      '<button type="button" onclick="markAsDone(this.id)" class="btn ms-2 btn-success text-white" id="'+data+'">Mark as done</button>'+
                      '</div>';
                }},
            ];

            // Create DataTable
            let table = new DataTable('#myTable', {
                searching: false,
                paging: false,
                scrollY: 200,
                responsive: true,
                fixedHeader: true,
                ordering:false,
                info: false,
                data: dynamicData, // Set the data for the table
                columns: columns,
                drawCallback: function () {
                    $('.dataTables_scrollBody').addClass('border-0');
                    popoverList.forEach((popover) => {
                    popover.update();
                  });
                  $('.sorting_disabled').addClass('border-0');
                  $('.dataTables_scrollHead').addClass('d-none');
                }
            });
        }
      
      function createDataTable2(data) {
          // Example data (replace this with your dynamic data)
          let dynamicData = data;

          // Customize columns
          let columns = [
              {
                render: function (data, type, row) {
                  // You can customize the rendering of data in this column
                  return '<div style = "width: 200px;">'+data+'</div>';
              }},
              {
                render: function (data, type, row) {
                  // You can customize the rendering of data in this column
                  return '<div style = "width: 200px;">'+data+'</div>';
              }},
              {
                render: function (data, type, row) {
                  // You can customize the rendering of data in this column
                  return '<div class="mb-2" style = "width: 200px;">'+
                    '<button type="button" onclick="showMore2(this.id)" class="btn btn-primary more_details" id="'+data+'" data-coreui-toggle="modal" data-coreui-target="#show_accident_incident_area">More</button>'+
                    '</div>';
              }},
          ];

          // Create DataTable
          let table = new DataTable('#myTable2', {
              searching: false,
              paging: false,
              scrollY: 200,
              responsive: true,
              fixedHeader: true,
              ordering:false,
              info: false,
              data: dynamicData, // Set the data for the table
              columns: columns,
              drawCallback: function () {
                  $('.dataTables_scrollBody').addClass('border-0');
                $('.sorting_disabled').addClass('border-0');
                $('.dataTables_scrollHead').addClass('d-none');
              }
          });
      }

      async function showRespondedAlerts(head_quarter) {
      const q = query(
        collection(db, "temp_logs"),
        where("headquarter_id", "==", head_quarter),
        where("responded", "==", true)
      );

      const querySnapshot = await getDocs(q);

      let dynamicData = [];

      querySnapshot.forEach((doc) => {
        // Retrieve document ID
        const docId = doc.id;

        // Retrieve specific fields from the document
        const data = doc.data();
        const Date = data.date_added.toDate(); // Replace "field1" with the actual field name
        const Location = data.alert_location; // Replace "field2" with the actual field name

        // Create an object with document ID and matched fields
        const documentInfo = [
          Location,
          Date,
          docId,
      ];

        dynamicData.push(documentInfo);
      });

      // Now, dynamicData contains an array of objects with document ID and matched fields
      console.log(dynamicData);
      createDataTable(dynamicData);
    }

      async function showUnrespondedAlerts(head_quarter) {
        const q = query(
          collection(db, "temp_logs"),
          where("headquarter_id", "==", head_quarter),
          where("responded", "==", false)
        );

        const querySnapshot = await getDocs(q);

        let dynamicData = [];

        querySnapshot.forEach((doc) => {
          // Retrieve document ID
          const docId = doc.id;

          // Retrieve specific fields from the document
          const data = doc.data();
          const Date = data.date_added.toDate(); // Replace "field1" with the actual field name
          const Location = data.alert_location; // Replace "field2" with the actual field name

          // Create an object with document ID and matched fields
          const documentInfo = [
            Location,
            Date,
            docId,
        ];

          dynamicData.push(documentInfo);
        });

        // Now, dynamicData contains an array of objects with document ID and matched fields
        console.log(dynamicData);
        createDataTable2(dynamicData)
      }

      window.showMore = function(value) {
          getDataByDocumentId(value)
          document.getElementById('mark_as_done').onclick = function ()
          {
            deleteData(value);
          }
      };
      
      window.showMore2 = function(value) {
          getDataByDocumentId2(value)
      };
      
      window.markAsDone = function(value) {
           deleteData(value);
      }

      async function getDataByDocumentId(docId) {
      const docRef = doc(db, "temp_logs", docId);

      try {
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          // Document exists, you can access its data
          const data = docSnap.data();
          const file_url = data.media_url;
          const alert_location = data.alert_location;
          const alert_By = data.user_name;
          setContent(file_url, alert_location, alert_By, true)
          
        } else {
          console.log("No such document!");
        }
      } catch (e) {
        console.error("Error getting document:", e);
      }
     }

      async function getDataByDocumentId2(docId) {
      const docRef = doc(db, "temp_logs", docId);

      try {
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          // Document exists, you can access its data
          const data = docSnap.data();
          const file_url = data.media_url;
          const alert_location = data.alert_location;
          const alert_By = data.user_name;
          setContent(file_url, alert_location, alert_By, false)
          
        } else {
          console.log("No such document!");
        }
      } catch (e) {
        console.error("Error getting document:", e);
      }
     }

      async function deleteData(id) 
      {
        const docRef = doc(db, "temp_logs", id);
        try {
          const docSnap = await getDoc(docRef);

          if (docSnap.exists()) {
            // Document exists, you can access its data
            
            const data = docSnap.data();
            const profile = document.getElementById("profile_id").textContent;
            const expoToken = data.expoToken;
            const head_quarter = data.headquarter_id;
            const hqLocationName = data.headquarter_location_name;
            const accident_incident_area_title_text = data.alert_location;

            let message = ' has successfully responded to your report. Victims are sent to the nearest hospital\n\nThis message is from ' + capitalizeFirstLetterOfWords(head_quarter) + ' headquarters.\n\nHeadquarter Location: '+capitalizeFirstLetterOfWords(hqLocationName)
            let markAsDone = true;
            sendPushNotification(expoToken, profile, head_quarter, accident_incident_area_title_text, false, message, markAsDone);

            await deleteDoc(docRef);
            respondedCount(head_quarter)
            
            
          } else {
            console.log("No such document!");
          }
        } catch (e) {
          console.error("Error getting document:", e);
        }
      }

      async function responded(head_quarter, profile, hqLocationName) {
        
        var accident_incident_area_title = document.getElementById("accident_incident_area_title");
          var accident_incident_area_title_text = accident_incident_area_title.textContent || accident_incident_area_title.innerText;

          var alerterId = document.getElementById("alerterId");
          var alerterId_text = alerterId.textContent || alerterId.innerText;

          // Define your query with multiple conditions
          const q = query(collection(db, "temp_logs"), 
            where("headquarter_id", "==", head_quarter),
            where("alert_location", "==", accident_incident_area_title_text),
            where("user_name", "==", alerterId_text),
            where("responded", "==", false)
          );

          // Execute the query and retrieve the documents
          const querySnapshot = await getDocs(q);

          // Iterate through the documents to get the "expoToken" values
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const expoToken = data.expoToken;

            let message = ' is currently underway. Please wait for the responding team.\n\nThis message is from ' + capitalizeFirstLetterOfWords(head_quarter) + ' headquarters.\n\nHeadquarter Location: '+hqLocationName
            let markAsDone = false;
            sendPushNotification(expoToken, profile, head_quarter, accident_incident_area_title_text, alerterId_text, message, markAsDone);
            
          });
      }

      async function getHospitalList() {
      const hospitalsCollection = collection(db, '/profile/hospital/head_quarters');

      try {
        const snapshot = await getDocs(hospitalsCollection);
        
        const hospitals = [];

        snapshot.forEach((doc) => {
          const data = doc.data();
          //query fields of each document ids
          const { lat, long, hospital_address } = data;

           // Log document ID along with lat and long
          const docId = doc.id;

          // push to the hospitals array
          hospitals.push({ docId, lat, long, hospital_address });
        });

        return hospitals;
      } catch (error) {
        console.error('Error getting hospitals:', error);
        throw error; // You may want to handle the error according to your application's needs
      }
    }

      function validateNewUserInfo(profile, role, head_quarter) 
      {
        let set_email_id = document.getElementById("set_email");
        let select_role_id = document.getElementById('select_role');
        let isValid = true;

        if(!validateEmail(set_email_id.value) || set_email_id.value.trim().length === 0)
        {
          set_email_id.classList.add("is-invalid");
          isValid = false;
        }

        if(select_role_id.value.trim().length === 0)
        {
          select_role_id.classList.add("is-invalid");
          isValid = false;
        }

        if(isValid)
        {
          createNewUser(set_email_id.value, profile, select_role_id.value, head_quarter)
        }
      }

      async function createNewUser(set_email_id, profile, role, head_quarter)
      {
          try {
            // Reference to the collection
            const allowedToRegisterCollection = collection(db, 'allowed_to_register_list');

            // Document ID and data to be added
            const documentId = set_email_id;
            const documentData = {
              head_quarter: head_quarter,
              profile: profile,
              role: 'User'
            };

            // Check if the document with the given ID already exists
            const documentRef = doc(allowedToRegisterCollection, documentId);
            const docSnapshot = await getDoc(documentRef);

            // If the document doesn't exist, add it
            if (!docSnapshot.exists()) {
              await setDoc(documentRef, documentData);
              console.log(`Document added successfully: ${documentId}`);
              toastMixin.fire({
                title: `Document added successfully: ${documentId}`,
                icon: 'success',
                timer: 3000
              });
              sendRegLinkEmail(set_email_id);
            } else {
              console.log(`Document with ID ${documentId} already exists. Not adding.`);
            }
          } catch (error) {
            console.error('Error adding document to allowed list:', error);
          }
      }

      function sendRegLinkEmail(set_email_id)
      {
        (function(){
          emailjs.init("Te40Xsil_hSF2ZAdz"); // Account Public Key
        })();

        // Get the current page URL
        let currentPageLink = window.location.href;

        // Log the URL to the console after removing "index.html/"
        const regLink = `${currentPageLink.replace("index.html", "")}register.html?email=${set_email_id}`;
        console.log(regLink);

        var params = {
          sendername: "Intelligent Rescue Management System",
          to: set_email_id,
          subject: "IRMS Registration Link",
          message: `Hello ${set_email_id}, This is your registration Link: ${regLink}`,
        };

        var serviceID = "service_v0okjpn"; // Email Service ID
        var templateID = "template_j4bo24p"; // Email Template ID

        emailjs.send(serviceID, templateID, params)
        .then( res => {
            let set_email_id = document.getElementById("set_email");
            let select_role_id = document.getElementById('select_role');
            toastMixin.fire({
                title: `Email sent successfully!!`,
                icon: 'success',
                timer: 3000
              });
              set_email_id.value = '';
              select_role_id.value = '';
            $('#add_new_user_form').modal('hide');
        })
        .catch((error) => {
          toastMixin.fire({
                title: `Something went wrong: ${error}`,
                icon: 'error',
                timer: 3000
              });
        })
      }

      function validateEmail(email) {
          // Regular expression for a simple email validation
          var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

          // Test the email against the regular expression
          return emailRegex.test(email);
      }  
    </script>
  </body>
</html>